name: ğŸš€ Crypto Projects Scanner

on:
  # Run every 6 hours automatically
  schedule:
    - cron: '0 */6 * * *'
  
  # Allow manual trigger from GitHub UI
  workflow_dispatch:

jobs:
  scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: ğŸ“¦ Install dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ğŸ”‘ Setup session file
      run: |
        echo "${{ secrets.TELEGRAM_SESSION_STRING }}" > session_string.txt
        
    - name: ğŸ” Run Fresh Scanner
      env:
        TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
        TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
        TELEGRAM_SESSION_STRING: ${{ secrets.TELEGRAM_SESSION_STRING }}
        PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
        GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
        GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
      run: |
        echo "ğŸš€ Starting Fresh Crypto Scanner..."
        echo "ğŸ“… Scan started at: $(date)"
        echo "ğŸ¯ Target groups: [OS] Projects, Oversubscribed groups, etc."
        echo
        
        python3 -c "
        import asyncio
        import sys
        import os
        import json
        from datetime import datetime
        
        # Import fresh_scanner functions
        from fresh_scanner import run_daily_scan, upload_to_google_sheets
        
        async def main():
            print('ğŸ” Running daily crypto scan...')
            print('ğŸ“± Scanning Telegram groups for new projects...')
            print()
            
            try:
                # Run the daily scan (this scans all groups and finds projects)
                results = await run_daily_scan()
                
                if 'error' in results:
                    print(f'âŒ Scanner error: {results[\"error\"]}')
                    return False
                
                projects_found = results.get('projects_found', 0)
                fresh_projects = results.get('fresh_projects', 0)
                duplicates = results.get('duplicate_projects', 0)
                uploaded = results.get('projects_uploaded', 0)
                messages_scanned = results.get('messages_scanned', 0)
                
                print('ğŸ“Š SCAN RESULTS:')
                print(f'   ğŸ’¬ Messages scanned: {messages_scanned}')
                print(f'   ğŸ”¥ Total projects found: {projects_found}')
                print(f'   ğŸ”„ Duplicates filtered: {duplicates}')
                print(f'   âœ¨ Fresh projects: {fresh_projects}')
                print(f'   ğŸ“¤ Uploaded to sheets: {uploaded}')
                print()
                
                if fresh_projects > 0:
                    print('ğŸ‰ SUCCESS! New crypto projects found and uploaded!')
                    projects = results.get('projects', [])
                    for i, project in enumerate(projects[:5], 1):  # Show first 5
                        name = project.get('project_name', 'Unknown')
                        source = project.get('source_group', 'Unknown')
                        print(f'   {i}. {name} (from {source})')
                    
                    if len(projects) > 5:
                        print(f'   ... and {len(projects) - 5} more projects')
                    
                    print()
                    print(f'ğŸ”— Check your Google Sheets: https://docs.google.com/spreadsheets/d/{os.getenv(\"GOOGLE_SHEET_ID\")}')
                else:
                    print('ğŸ“­ No new crypto projects found in the last 24 hours.')
                    print('ğŸ’¡ This could mean:')
                    print('   â€¢ Groups have been quiet')
                    print('   â€¢ All recent projects were already scanned')
                    print('   â€¢ No messages met the crypto project criteria')
                
                print()
                print(f'âœ… Scan completed at: {datetime.now().strftime(\"%Y-%m-%d %H:%M:%S\")} UTC')
                return True
                
            except Exception as e:
                print(f'âŒ SCAN FAILED: {str(e)}')
                print('ğŸ’¡ This might be due to:')
                print('   â€¢ Invalid API credentials')
                print('   â€¢ Network connectivity issues')  
                print('   â€¢ Telegram session expired')
                print('   â€¢ Google Sheets access problems')
                return False
        
        # Run the scanner
        success = asyncio.run(main())
        sys.exit(0 if success else 1)
        "
        
    - name: ğŸ‰ Scan Complete
      if: always()
      run: |
        echo
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ¯ GitHub Actions Crypto Scanner Complete"
        echo "ğŸ“… Finished at: $(date)"
        echo "ğŸ”„ Next scan in 6 hours (automatic)"
        echo "ğŸ“Š Check your Google Sheets for results"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" 